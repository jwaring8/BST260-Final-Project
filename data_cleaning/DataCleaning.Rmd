---
title: "DataCleaning"
output: html_document
---
 
```{r, message = FALSE}
library(dplyr)
library(tidyverse)
library(foreign)
library(data.table)
library(mltools)
```

### Read in the dataset 
```{r}
## Reading in data
d <- read.csv("../dataset/diabetic_data.csv")
```

### Filter out Patients who Expired 

We need to first drop any patients who's discharge status is listed as "expired". If a patient has died, there is no chance of readmission. 
```{r}
# Confirmed that none of the patients who expired were listed as readmitted
d <- filter(d, !(discharge_disposition_id %in% c(11, 19, 20, 21)))
```

### Filter out Patients who have a gender of Unknown/Invalid (3 subjects)
```{r}
d <- d %>% filter(gender != "Unknown/Invalid")

# dropping the unused level "Unknown/Invalid"
d$gender <- droplevels(d$gender)
```


### Drop Columns 

Next, we will drop some of the columns for various reasons: 
- Encounter ID: an uneccessary column that provides no information for readmission 
- Patient Number: an unecessary column that provides no information for readmission
- Weight: While potentially useful, there is too many missing values 
- Payer Code: too many missing values 
- Medical Specialty: probably unecessary and too many missing values 
- Diabetes Medication: redundant information 

```{r}
drops <- c("encounter_id", "patient_nbr", "weight", "payer_code", "medical_specialty", "diabetesMed")
d <- d[ , !(names(d) %in% drops)]
```

### Data Encodings 

- Gender will be encoded as 0 for Female, 1 for Male, and 2 for Unknown/Invalid 
```{r}
d$gender <- as.integer(d$gender) - 1
```

- Age is given as 10 year intervals. We will split this interval into two seperate columns: `start_age` and `end_age`
```{r}
# Encoding ages
d$start_age <- ifelse(d$age == "[0-10)", 0, 
                  ifelse(d$age == "[10-20)", 10, 
                         ifelse(d$age == "[20-30)", 20, 
                                ifelse(d$age == "[30-40)", 30, 
                                       ifelse(d$age == "[40-50)", 40, 
                                              ifelse(d$age == "[50-60)", 50, 
                                                     ifelse(d$age == "[60-70)", 60, 
                                                            ifelse(d$age == "[70-80)", 70, 
                                                                   ifelse(d$age == "[80-90)", 80, 90)))))))))
                                                                         
d$end_age <- ifelse(d$age == "[0-10)", 10, 
                  ifelse(d$age == "[10-20)", 20, 
                         ifelse(d$age == "[20-30)", 30, 
                                ifelse(d$age == "[30-40)", 40, 
                                       ifelse(d$age == "[40-50)", 50, 
                                              ifelse(d$age == "[50-60)", 60, 
                                                     ifelse(d$age == "[60-70)", 70, 
                                                            ifelse(d$age == "[70-80)", 80, 
                                                                   ifelse(d$age == "[80-90)", 90, 100)))))))))
                                                                    
d <- within(d, rm(age))
```

- Glucose Serum will be encoded as follows: 
    - 0 for No measurment
    - 1 for Normal reading 
    - 2 for >200
    - 3 for >300
```{r}
d$max_glu_serum <- ifelse(d$max_glu_serum == "None", 0, 
                          ifelse(d$max_glu_serum == "Norm", 1, 
                                 ifelse(d$max_glu_serum == ">200", 2, 3)))
```

- A1C test results will be encoded as follows: 
    - 0 for No measurement 
    - 1 for Normal reading 
    - 2 for an abnormal reading (>7 or >8)
```{r}
# A1C change to abnormal (>7 and >8) = 2 , normal = 1, and none = 0
d$A1Cresult <- ifelse(d$A1Cresult == "None", 0, 
                         ifelse(d$A1Cresult == "Norm", 1, 
                                ifelse(d$A1Cresult %in% c(">7", ">8"), 2, "NULL")))
```

- Changes in insulin doage will be encoded as follows:
    - 0 for no insulin
    - 1 for decrease in insulin
    - 2 for steady insulin
    - 3 for increase in insulin
```{r}
d$insulin <- ifelse(d$insulin == "No",0, ifelse(d$insulin == "Down", 1, ifelse(d$insulin == "Steady", 2, 3)))
```

- Change in Medincations will be encoded as follows:
    - 0 for no change in medication
    - 1 for change in medication
```{r}
d$change <- ifelse(d$change == "Ch", 1, 0)
```

- Readmitted Status will be encoded as follows: 
    - 0 for no readmission
    - 1 for a readmission in 30+ days 
    - 2 for readmission in <30 days 
```{r}
d$readmitted <- ifelse(d$readmitted == "NO", 0, ifelse(d$readmitted == ">30", 1, 2))
```


- Race will be encoded as follows: 
    - 0 for Caucasian
    - 1 for African American 
    - 2 for Other
```{r}
d$race <- ifelse(d$race == "Caucasian", 0, ifelse(d$race == "AfricanAmerican", 1, 2))
```


### New Features 

- Healthcare Utilization is calculated as the sum of number of outpatient, emergency, and inpatient encouters the patient has had in the past year
```{r}
# Sum of number of outpatient, emergency and inpatient encounters 
d$healthcare_utilization <- (d$number_outpatient + d$number_emergency + d$number_inpatient)
```

- Sum on non-insulin diabetes medications 
```{r}
# Creating sum of other meds on column
# (not all of these columns have all four options, but it was easier to code this way - gives same result)
d$metformin <- ifelse(d$metformin %in% c("Up", "Steady", "Down"),1,0)
d$repaglinide <- ifelse(d$repaglinide %in% c("Up", "Steady", "Down"),1,0)
d$nateglinide <- ifelse(d$nateglinide %in% c("Up", "Steady", "Down"),1,0)
d$chlorpropamide <- ifelse(d$chlorpropamide %in% c("Up", "Steady", "Down"),1,0)
d$glimepiride <- ifelse(d$glimepiride %in% c("Up", "Steady", "Down"),1,0)
d$acetohexamide <- ifelse(d$acetohexamide %in% c("Up", "Steady", "Down"),1,0)
d$glipizide <- ifelse(d$glipizide %in% c("Up", "Steady", "Down"),1,0)
d$glyburide <- ifelse(d$glyburide %in% c("Up", "Steady", "Down"),1,0)
d$tolbutamide <- ifelse(d$tolbutamide %in% c("Up", "Steady", "Down"),1,0)
d$pioglitazone <- ifelse(d$pioglitazone %in% c("Up", "Steady", "Down"),1,0)
d$rosiglitazone <- ifelse(d$rosiglitazone %in% c("Up", "Steady", "Down"),1,0)
d$acarbose <- ifelse(d$acarbose %in% c("Up", "Steady", "Down"),1,0)
d$miglitol <- ifelse(d$miglitol %in% c("Up", "Steady", "Down"),1,0)
d$troglitazone <- ifelse(d$troglitazone %in% c("Up", "Steady", "Down"),1,0)
d$tolazamide <- ifelse(d$tolazamide %in% c("Up", "Steady", "Down"),1,0)
d$examide <- ifelse(d$examide %in% c("Up", "Steady", "Down"),1,0)
d$citoglipton <- ifelse(d$citoglipton %in% c("Up", "Steady", "Down"),1,0)
d$glyburide.metformin <- ifelse(d$glyburide.metformin %in% c("Up", "Steady", "Down"),1,0)
d$glipizide.metformin <- ifelse(d$glipizide.metformin %in% c("Up", "Steady", "Down"),1,0)
d$glimepiride.pioglitazone <- ifelse(d$glimepiride.pioglitazone %in% c("Up", "Steady", "Down"),1,0)
d$metformin.rosiglitazone <- ifelse(d$metformin.rosiglitazone %in% c("Up", "Steady", "Down"),1,0)
d$metformin.pioglitazone <- ifelse(d$metformin.pioglitazone %in% c("Up", "Steady", "Down"),1,0)

d$num_other_diabetes_meds_up_stdy_dwn <- (d$metformin + d$repaglinide + d$nateglinide + d$chlorpropamide + d$glimepiride + d$acetohexamide + d$glipizide + d$glyburide + d$tolbutamide + d$pioglitazone + d$rosiglitazone + d$acarbose + d$miglitol + d$troglitazone + d$tolazamide + d$examide + d$citoglipton + d$glyburide.metformin + d$glipizide.metformin + d$glimepiride.pioglitazone + d$metformin.rosiglitazone + d$metformin.pioglitazone)


drops2 <- c("metformin", "repaglinide", "nateglinide", "chlorpropamide", "glimepiride", "acetohexamide", "glipizide", 
            "glyburide", "tolbutamide", "pioglitazone", "rosiglitazone", "acarbose", "miglitol", "troglitazone", 
            "tolazamide", "examide", "citoglipton", "glyburide.metformin", "glipizide.metformin", "glimepiride.pioglitazone",
            "metformin.rosiglitazone", "metformin.pioglitazone")

d <- d[ , !(names(d) %in% drops2)]
```

### One Hot Encodings 

- Admission types, discharge dispositions, admission source will be grouped an one hot encoded s
```{r}
# set up dummy variables for admission types
d <- mutate(d, at_emergent = as.numeric(admission_type_id %in% c(1, 2, 7)), 
              at_elective = as.numeric(admission_type_id == 3), 
              at_other = as.numeric(admission_type_id %in% c(4, 5, 6, 8)))

# Set up dummy variables for discharge dispositions
d <- mutate(d, dd_home = as.numeric(discharge_disposition_id %in% c(1, 6, 8)), 
              dd_facility_transfer = as.numeric(discharge_disposition_id %in% c(2, 3, 4, 5, 10, 16, 17, 22, 23, 24, 30, 27, 28, 29, 13, 14)), 
              dd_other = as.numeric(discharge_disposition_id %in% c(7, 18, 25, 26, 9, 12, 15))) 
              # dd_admitted = as.numeric(discharge_disposition_id %in% c(9, 12, 15)), #lumping admitted into other
              # add_expired = as.numeric(discharge_disposition_id %in% c(11, 19, 20, 21)), (dropped patients who expired)
              # dd_hospice = as.numeric(discharge_disposition_id %in% c(13, 14))) #lumping hospice into transfer

# Set up dummy variables for admission source
d <- mutate(d, as_outpatient = as.numeric(admission_source_id %in% c(1, 2, 3)),
              as_facility_transfer = as.numeric(admission_source_id %in% c(4, 5, 6, 10, 18, 19, 22, 25, 26)),
              as_ed = as.numeric(admission_source_id %in% c(7)),
              as_other = as.numeric(admission_source_id %in% c(8, 9, 15, 17, 20, 21, 11, 12, 13, 14, 23, 24)))
              #as_newborn = as.numeric(admission_source_id %in% c(11, 12, 13, 14, 23, 24)))#as_newborn added to as_other

d <- within(d, rm(admission_type_id))
d <- within(d, rm(discharge_disposition_id))
d <- within(d, rm(admission_source_id))
```

- ICD codes have over 700 different "levels" in our dataframe. We will group these ICD codes into 20 different categories based on the [Strack et al. 2014 paper](https://www.hindawi.com/journals/bmri/2014/781670/). We will then one hot encode these categories for each patient. 

```{r}
d$diag_1 <- as.character(d$diag_1)
d$diag_2 <- as.character(d$diag_2)
d$diag_3 <- as.character(d$diag_3)

d$diag_1grp <- ifelse (d$diag_1 == "?", "Unknown", 
          ifelse(grepl(d$diag_1, pattern = "[EV]") == T, "External", 
            ifelse(floor(as.numeric(d$diag_1)) == 250, "Circulatory", 
              ifelse(d$diag_1 %in% c(390:459, 785), "Diabetes", 
                ifelse(d$diag_1 %in% c(460:519, 786), "Respiratory", 
                  ifelse(d$diag_1 %in% c(520:579, 787), "Digestive", 
                    ifelse(d$diag_1 %in% c(800:999), "Injury", 
                      ifelse(d$diag_1 %in% c(710:739), "Musculoskeletal",
                        ifelse(d$diag_1 %in% c(580:629, 788), "Genitourinary", 
                         ifelse(d$diag_1 %in% c(140:239), "Neoplasm", 
                           ifelse(d$diag_1 %in% c(780, 781, 784, 790:799, 740:759), "Other", # added congenital to other
                             ifelse(d$diag_1 %in% c(240:249, 251:279), "Endocrine_Nutrition_Metabolic",  
                               ifelse(d$diag_1 %in% c(680:709, 782), "Skin", 
                                 ifelse(d$diag_1 %in% c(001:139), "Infectious",
                                   ifelse(d$diag_1 %in% c(290:319), "Mental", 
                                     ifelse(d$diag_1 %in% c(280:289), "Blood",
                                       ifelse(d$diag_1 %in% c(320:359), "Nervous",
                                         ifelse(d$diag_1 %in% c(630:679), "Pregnancy", 
                                          ifelse(d$diag_1 %in% c(360:389), "Sense", "NULL") 
                                            #ifelse(d$diag_1 %in% c(740:759), "Congenital", "NULL")
                                ))))))))))))))))))

d$diag_2grp <- ifelse (d$diag_2 == "?", "Unknown", 
          ifelse(grepl(d$diag_2, pattern = "[EV]") == T, "External", 
            ifelse(floor(as.numeric(d$diag_2)) == 250, "Circulatory", 
              ifelse(d$diag_2 %in% c(390:459, 785), "Diabetes", 
                ifelse(d$diag_2 %in% c(460:519, 786), "Respiratory", 
                  ifelse(d$diag_2 %in% c(520:579, 787), "Digestive", 
                    ifelse(d$diag_2 %in% c(800:999), "Injury", 
                      ifelse(d$diag_2 %in% c(710:739), "Musculoskeletal",
                        ifelse(d$diag_2 %in% c(580:629, 788), "Genitourinary", 
                         ifelse(d$diag_2 %in% c(140:239), "Neoplasm", 
                           ifelse(d$diag_2 %in% c(780, 781, 784, 790:799, 740:759), "Other", # added congenital to other
                             ifelse(d$diag_2 %in% c(240:249, 251:279), "Endocrine_Nutrition_Metabolic",  
                               ifelse(d$diag_2 %in% c(680:709, 782), "Skin", 
                                 ifelse(d$diag_2 %in% c(001:139), "Infectious",
                                   ifelse(d$diag_2 %in% c(290:319), "Mental", 
                                     ifelse(d$diag_2 %in% c(280:289), "Blood",
                                       ifelse(d$diag_2 %in% c(320:359), "Nervous",
                                         ifelse(d$diag_2 %in% c(630:679), "Pregnancy", 
                                          ifelse(d$diag_2 %in% c(360:389), "Sense", "NULL") 
                                            #ifelse(d$diag_2 %in% c(740:759), "Congenital", "NULL")
                                ))))))))))))))))))

d$diag_3grp <- ifelse (d$diag_3 == "?", "Unknown", 
          ifelse(grepl(d$diag_3, pattern = "[EV]") == T, "External", 
            ifelse(floor(as.numeric(d$diag_3)) == 250, "Circulatory", 
              ifelse(d$diag_3 %in% c(390:459, 785), "Diabetes", 
                ifelse(d$diag_3 %in% c(460:519, 786), "Respiratory", 
                  ifelse(d$diag_3 %in% c(520:579, 787), "Digestive", 
                    ifelse(d$diag_3 %in% c(800:999), "Injury", 
                      ifelse(d$diag_3 %in% c(710:739), "Musculoskeletal",
                        ifelse(d$diag_3 %in% c(580:629, 788), "Genitourinary", 
                         ifelse(d$diag_3%in% c(140:239), "Neoplasm", 
                           ifelse(d$diag_3 %in% c(780, 781, 784, 790:799, 740:759), "Other", # added congenital to other
                             ifelse(d$diag_3 %in% c(240:249, 251:279), "Endocrine_Nutrition_Metabolic",  
                               ifelse(d$diag_3 %in% c(680:709, 782), "Skin", 
                                 ifelse(d$diag_3 %in% c(001:139), "Infectious",
                                   ifelse(d$diag_3 %in% c(290:319), "Mental", 
                                     ifelse(d$diag_3 %in% c(280:289), "Blood",
                                       ifelse(d$diag_3 %in% c(320:359), "Nervous",
                                         ifelse(d$diag_3 %in% c(630:679), "Pregnancy", 
                                          ifelse(d$diag_3 %in% c(360:389), "Sense", "NULL") 
                                           # ifelse(d$diag_3 %in% c(740:759), "Congenital", "NULL")
                                ))))))))))))))))))


d$diag_1grp <- as.factor(d$diag_1grp)
d$diag_2grp <- as.factor(d$diag_2grp)
d$diag_3grp <- as.factor(d$diag_3grp)

d <- one_hot(data.table(d))
d <- as.data.frame(d) # convert back to data.frame format

d <- d %>% mutate(diag_1grp_Unknown = diag_1grp_Unknown + diag_1grp_NULL, 
                  diag_2grp_Unknown = diag_2grp_Unknown + diag_3grp_Unknown + diag_2grp_NULL + diag_3grp_NULL, 
                  diag_2grp_External = diag_2grp_External + diag_3grp_External, 
                  diag_2grp_Circulatory = diag_2grp_Circulatory + diag_3grp_Circulatory,
                  diag_2grp_Diabetes = diag_2grp_Diabetes + diag_3grp_Diabetes, 
                  diag_2grp_Respiratory = diag_2grp_Respiratory + diag_3grp_Respiratory, 
                  diag_2grp_Digestive = diag_2grp_Digestive + diag_3grp_Digestive, 
                  diag_2grp_Injury = diag_2grp_Injury + diag_3grp_Injury, 
                  diag_2grp_Musculoskeletal = diag_2grp_Musculoskeletal + diag_3grp_Musculoskeletal, 
                  diag_2grp_Genitourinary = diag_2grp_Genitourinary + diag_3grp_Genitourinary, 
                  diag_2grp_Neoplasm = diag_2grp_Neoplasm + diag_3grp_Neoplasm, 
                  diag_2grp_Other = diag_2grp_Other + diag_3grp_Other, 
                  diag_2grp_Endocrine_Nutrition_Metabolic =  diag_2grp_Endocrine_Nutrition_Metabolic + 
                    diag_3grp_Endocrine_Nutrition_Metabolic, 
                  diag_2grp_Skin = diag_2grp_Skin + diag_3grp_Skin, 
                  diag_2grp_Infectious = diag_2grp_Infectious + diag_3grp_Infectious, 
                  diag_2grp_Mental = diag_2grp_Mental + diag_3grp_Mental, 
                  diag_2grp_Blood = diag_2grp_Blood, diag_3grp_Blood, 
                  diag_2grp_Nervous = diag_2grp_Nervous + diag_3grp_Nervous, 
                  diag_2grp_Pregnancy = diag_2grp_Pregnancy + diag_3grp_Pregnancy, 
                  diag_2grp_Sense = diag_2grp_Sense + diag_3grp_Sense) 
                  # diag_2grp_Congenital = diag_2grp_Congenital + diag_3grp_Congenital) #congenital grouped into otuher

d <- within(d, rm(diag_1))
d <- within(d, rm(diag_1grp_NULL))
d <- within(d, rm(diag_2))
d <- within(d, rm(diag_2grp_NULL))
d <- d %>% select(-starts_with("diag_3"))
```




```{r}
# write data to csv file
d <- d %>% select(-readmitted, readmitted) # move readmitted to the last column value
write.csv(d, file = "../dataset/clean_diabetic_data.csv", row.names = F)
```